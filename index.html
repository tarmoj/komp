<!DOCTYPE html>
<!--player lehelt: https://github.com/surikov/webaudiofont  -->
<html>
  <head>
    <title>Muusikaharjutused</title>
    <meta content="">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=1" />
    <style></style>
    
    <script src="https://unpkg.com/vextab/releases/vextab-div.js"></script>    
    <script src='https://surikov.github.io/webaudiofont/npm/dist/WebAudioFontPlayer.js'></script>
    <script src='https://surikov.github.io/webaudiofontdata/sound/0000_JCLive_sf2_file.js'> </script>
	<script src="baseclass.js"></script>
	<script src="find_missing_duration.js"></script>
	<script src="name_duration.js"></script>
    <script>
    
	var exercise; 
	
    
    // different exercises are defined as different functions in separate .js files

// 1.3.5 Helikõrgus    Viiulivõti/Bassivõti. Antud on helikõrgus noodijoonestikul. Kirjelda helikõrguse asukohta noodijoonestikul (mitmendal joonel või mitmendas vahes) ja anna helikõrguse tähtnimetus ja silpnimetus.


function describeNote() {
// variables
	var duration = -1;
	var answered = false;
	var selectedNoteIndex = -1;
	
	// Create or set necessary HTML elements
	document.getElementById("exerciseTitle").innerHTML = "Kirjelda helikõrguse asukohta";
	document.getElementById("description").innerHTML = "Antud on helikõrgus noodijoonestikul. Kirjelda helikõrguse asukohta noodijoonestikul (mitmendal joonel või mitmendas vahes) ja anna helikõrguse tähtnimetus ja silpnimetus."; 
	document.getElementById("question").innerHTML =	"Kirjelda noodi asukohta. Mis noot see on?";
	
	var oldIndex = -1; // to check that same random value is not used twice in a row
	var answerString = "";
	var positions = [ // array to describe the note posistions as strings (in Estonian now)
		{position:0,positionStrin:"joonel"}, 
		{position:1,positionString:"vahes"},
		{position:-1,positionString:"joone all"},
		{position:2,positionString:"joone peal"},
		{position:-10,positionString:"alumisel abijoonel"},
		{position:-11,positionString:"alumise abijoone all"},
		{position:10,positionString:"ülemisel abijoonel"},
		{position:11,positionString:"ülemise abijoone peal"}
		
	];
	var trebleClefNotes = [  // lineOrSpace: 1...5; position: 0 - on the line, 1 -in the space, -1 - under line, 2 - on the line (like g2), -10 - on lower ledger line, -11 under lower ledger line; 10 - on upper ledeger line, 11 - above upper ledger line
		{vtNote:"A/3", name:"A", syllable:"La", lineOrSpace: 2, position:-10 },
		{vtNote:"B/3", name:"H", syllable:"Si", lineOrSpace: 1, position:-11 },
		{vtNote:"C/4", name:"C", syllable:"Do", lineOrSpace: 1, position:-10 },
		//{vtNote:"C#/4", name:"Cis", syllable:"Do-diees", line: -1, position:-1 },
		{vtNote:"D/4", name:"D", syllable:"Re", lineOrSpace: 1, position:-1 },
		{vtNote:"E/4", name:"E", syllable:"Mi", lineOrSpace: 1, position:0 },
		{vtNote:"F/4", name:"C", syllable:"Fa", lineOrSpace: 1, position:1 },
		{vtNote:"G/4", name:"G", syllable:"Sol", lineOrSpace: 2, position:0 },
		{vtNote:"A/4", name:"A", syllable:"La", lineOrSpace: 2, position:1 },
		{vtNote:"B/4", name:"H", syllable:"Si", lineOrSpace: 3, position:0 },
		
		{vtNote:"C/5", name:"C", syllable:"Do", lineOrSpace: 3, position:1 },
		{vtNote:"D/5", name:"D", syllable:"Re", lineOrSpace: 4, position:0 },
		{vtNote:"E/5", name:"E", syllable:"Mi", lineOrSpace: 4, position:1 },
		{vtNote:"F/5", name:"F", syllable:"Fa", lineOrSpace: 5, position:0 },
		{vtNote:"G/5", name:"G", syllable:"Sol", lineOrSpace: 5, position:2 },
		{vtNote:"A/5", name:"A", syllable:"La", lineOrSpace: 1, position:10 },
		{vtNote:"B/5", name:"H", syllable:"Si", lineOrSpace: 1, position:11 },
		{vtNote:"C/6", name:"C", syllable:"Do", lineOrSpace: 2, position:10 },
		
	];
	
	
	function getPositionString(index) {
		var result = trebleClefNotes[index].lineOrSpace + ". ";
		for (var i = 0; i < positions.length; i++) {  // do not use array.find for support of older browsers
			if (positions[i].position === trebleClefNotes[index].position) { 
				result += positions[i].positionString;
				break;
			} 
		}
		console.log("See noot asub: ", result);
		return result;
	}
	
	var oldResponse = document.getElementById("response");
	var response = document.createElement("div");
	response.id = "response";
	response.innerHTML = '<br>See noot asub: <select id="lineOrSpace">' +
		'<option value="1">1.</option>' + 
		'<option value="2">2.</option>' +
		'<option value="3">3.</option>' +
		'<option value="4">4.</option>' +
		'<option value="5">5.</option>' +
	'</select>' +
	'<select id="position">' +
		'<option value="0">joonel</option>' +
		'<option value="1">vahes</option>' +
		'<option value="-1">joone all</option>'+  // as d4
		'<option value="2">joone peal</option>' + // as g5
		'<option value="-10">alumisel abijoonel</option>' +
		'<option value="-11">alumise abijoone all</option>' + // as b3
		'<option value="10">ülemisel abijoonel</option>' + // as a5,c6
		'<option value="11">ülemise abijoone peal</option>' + // as b5
	'</select>' + 	
	'<br> Noodi nimi tähtnimetustena <input type="text" id="noteName" size=4></input>, ' +
	'silpnimetusena (do, re,mi)<input type="text" id="syllable" size=4></input><br>';

	
	if (oldResponse === null) {
		console.log("Creating new response element");
		document.getElementById("responseDiv"). appendChild(response)
	} else {
		console.log("Replacing response element");
		document.getElementById("responseDiv").replaceChild(response, oldResponse);
	}
	
	// set necessary methods in exercise
	exercise = new MusicExercise("mainCanvas", 100); // relatively narrow canvas
	exercise.time = ""; // no time signature

	document.getElementById("attempts").innerHTML = "0";
	document.getElementById("score").innerHTML = "0";
	
	
	exercise.generate = function() {
		
		selectedNoteIndex = Math.floor(Math.random()*trebleClefNotes.length );
		//not shure if midinote is good idea...
		
		while (selectedNoteIndex === oldIndex) { // to avoid same value twice
			selectedNoteIndex = Math.floor(Math.random()*trebleClefNotes.length );
		}
		oldIndex = selectedNoteIndex;
		exercise.notes = trebleClefNotes[selectedNoteIndex].vtNote;
		getPositionString(selectedNoteIndex); // late to checkResponse
		
		
		answered = false; // necessary to set a flag to check if the quetion has answered already in checkResponse
	
	}
	
	exercise.generate();		
	exercise.draw();
	
	document.getElementById("renewButton").onclick = function() {
		exercise.generate(); 
		exercise.draw();
	}
	
	exercise.checkResponse = function() { // TODO: - kas oleks võimalik tõsta baseclassi? Siis vist switch case peaks olema välditud ja õige vastus peaks olema juba loetava stringina nagu "poolnoot" - vist mõtekas. Samas, kuidas basclass tead html elementide ID-sid???

		//TODO: kontrolli, kas uuendatud, muidu tõstab ainult skoori...
		if (answered) {
			alert('Sa oled juba vastanud. Vajuta "Uuenda"');
			return;
		}
		exercise.attempts += 1;
		var feedback = "";
		var correct = false;
		if (parseInt(document.getElementById("lineOrSpace").value)===trebleClefNotes[selectedNoteIndex].lineOrSpace &&
			parseInt(document.getElementById("position").value)===trebleClefNotes[selectedNoteIndex].position) {
			feedback = "Asukoht õige!";
			correct = true;
		} else {
			feedback = "Vale! Õige asukoht: " + getPositionString(selectedNoteIndex);
			correct = false;
		}
		
		if (document.getElementById("noteName").value.toLowerCase()===trebleClefNotes[selectedNoteIndex].name.toLowerCase()) {
			feedback += " Tähtnimetus õige!";
			correct = correct && true;
		} else {
			feedback += " Tähtnimetus vale! Õige on: "+ trebleClefNotes[selectedNoteIndex].name;
			correct = correct && false;
		}
		
		if (document.getElementById("syllable").value.toLowerCase()===trebleClefNotes[selectedNoteIndex].syllable.toLowerCase()) {
			feedback += " Silpnimetus õige!";
			correct = correct && true;
		} else {
			feedback += " Silpnimetus vale! Õige on: "+ trebleClefNotes[selectedNoteIndex].syllable;
			correct = correct && false;
		}
		
		if (correct) {
			exercise.score += 1;
		}
		
		document.getElementById("attempts").innerHTML = exercise.attempts;
		document.getElementById("score").innerHTML = exercise.score;
		document.getElementById("feedback").innerHTML = feedback; 
		exercise.draw(); // redraw without rectangle
		answered = true;
	
	}

}
    
    
//    Harmoonia, harjutus 8.1  Antud on helistiku nimetus. Kirjuta võtmemärgid. Siin -  kuvatakse 6 märki, vali õige

function recognizeKeySignature() {
	// variables
	var key = "";
	// make it maybe property of exercise?
	// TODO: add user control up to how many 
	// maybe better array of objects {estMajor: "B duur", estMinor {"g moll"},  }
	var possibleKeys = ["C","G","G","D","Bb", "A", "Eb", "E", "Ab", "H", "Db", "F#", "Gb", "C#", "Cb"];
	var maxAccidentals = 4;
	var answered = false;
	
	// Create or set necessary HTML elements
	document.getElementById("exerciseTitle").innerHTML = "Määra helistik";
	document.getElementById("description").innerHTML = "Antud on helistik. Vali, millised on selle helistiku võtmemärgid."; 
	document.getElementById("question").innerHTML =	"Millised on õiged võtmemärgid";
	
	
	// TODO: vastus - click on bar
	
	
	
	// set necessary methods in exercise
	exercise = new MusicExercise("mainCanvas"); // relatively narrow canvas // CAN THIS BE A MEMORY LEAK?
	//exercise.attempts = 0; exercise.score = 0; // set in object create 
	exercise.time = ""; // no time signature

	document.getElementById("attempts").innerHTML = "0";
	document.getElementById("score").innerHTML = "0";
	
	
	exercise.generate = function() {
		var allowedDurations = [2, 1, 0.5, 0.25];
		var tryThis = allowedDurations[Math.floor(Math.random()*allowedDurations.length)];
		while (tryThis === duration) { // to avoid getting the same duration twice in a row
			console.log("Got the same, retrying");
			tryThis = allowedDurations[Math.floor(Math.random()*allowedDurations.length)];
		}
		duration = tryThis; 
		var flexDuration = (4/duration).toString();
		var isRest = ( Math.random() >=0.5 ); // 50/50% if notr or rest
		console.log("show rest: ", isRest);
		
		// create VexFlow string of notes
		
		var parseString = " :"+flexDuration ;
		parseString += (isRest) ?  " ##" : " B/4"; // add rest or note (B) 
		
		console.log("Generated notes: ", parseString);
		exercise.notes = parseString;
		answered = false; // necessary to set a flag to check if the quetion has answered already in checkResponse
	
	}
	
	exercise.generate();		
	exercise.draw();
	
	document.getElementById("renewButton").onclick = function() {
		exercise.generate(); 
		exercise.draw();
	}
	
	exercise.checkResponse = function() { // TODO: - kas oleks võimalik tõsta baseclassi? Siis vist switch case peaks olema välditud ja õige vastus peaks olema juba loetava stringina nagu "poolnoot" - vist mõtekas. Samas, kuidas basclass tead html elementide ID-sid???// Music exercises for "MUUSIKA KOMPOSITSIOONIÕPETUS"
// TODO: proper credits, copyright

		//TODO: kontrolli, kas uuendatud, muidu tõstab ainult skoori...
		if (answered) {
			alert('Sa oled juba vastanud. Vajuta "Uuenda"');
			return;
		}
		exercise.attempts += 1;
		var feedback = "";
		if (parseFloat(document.getElementById("response").value)===duration) {
			feedback = "Õige!"
			exercise.score += 1;
		} else {
			var durationString = "";
			switch (duration) {
				case 2:  durationString = "Poolnoot"; break;
				case 1:  durationString = "Veerandnoot"; break;
				case 0.5:  durationString = "Kaheksandik"; break;
				case 0.25:  durationString = "Kuueteistkümnendik"; break;
				default: durationString = "?"; break;
			}
			feedback = "Vale! Õige oli: "+durationString; 
		}
		
		
		document.getElementById("attempts").innerHTML = exercise.attempts;
		document.getElementById("score").innerHTML = exercise.score;
		document.getElementById("feedback").innerHTML = feedback; 
		exercise.draw(); // redraw without rectangle
		answered = true;
	
	}
}

    // TODO: create a hash of ecercsise names and numbers to link them to from URL
    //var exercises = [  ]
    
	window.onload = function() {
		
		// get GET parameter to load specific expikaercise set in URL
		// the link van be set as ?e=<exercise number> like e=1.2.3 The 'e' actually does not matter
		var searchString = window.location.search;
		if (searchString.length>0) {
			var parameters = searchString.split("&"); // remove ?
			var exerciseNumber = parameters[0].split("=")[1];
			console.log("you want to open exercise", exerciseNumber)
			switch (exerciseNumber) {
				case "1.2.2" : nameDuration(); break;
				case "1.2.3" : findMissingDuration(); break;
				default: console.log("Exercise "+exerciseNumber+" is unkonwn or not defined yet");
			}
			
		} else {		
// 			exercise = new MusicExercise("mainCanvas") ;
// 			exercise.draw(); // dummy exercise -  just show empty staff
			describeNote(); 
		}
	}


    
    </script>

    </head>
    
	<body>
	<a onclick="findMissingDuration()" href="#">Leia puuduv vältus</a> 
	<a onclick="nameDuration()" href="#">Määra helivältus</a> 
	jne
	<hr>
	<br>
	<h1 id="title">MUUSIKA KOMPOSITSIOONIÕPETUS. Harjutused</h1>
	<h2 id="exerciseTitle">Harjutuse nimi</h2>
	<br>
	<p id="description">Ülesande kirjeldus.</p>
	<br>
	<button id="playButton" onclick="exercise.play();">Mängi</button><br>
	<!-- for CANVAS backend: <canvas id="mainCanvas"></canvas>-->
	<div id="mainCanvas"></div>
	<br>
	<button id = "renewButton" onclick='console.log("Set the actions in your exercise definition.")'>Uuenda</button><br>
	<br>
	<span id="question">Küsimus</span>
	
	<span id="responseDiv">	
	</span>
	<button id="replyButton" onclick="exercise.checkResponse()">Vasta</button>
	
	<p id="feedback"></p>
	Katseid: <label id="attempts">0</label>. Neist õigeid vastuseid: <label id="score">0</label> 
	<button id="resetButton" onclick='exercise.attempts=0;exercise.score=0;attempts.innerHTML="0"; score.innerHTML = "0" '>Nulli</button>
	<br>
	

	</body>
</html>
